"use strict"; const express = require('express'); const line = require('@line/bot-sdk'); // LINE Bot SDK設定 const config = { channelSecret: process.env.CHANNEL_SECRET, channelAccessToken: process.env.CHANNEL_ACCESS_TOKEN }; // LINEクライアントの作成 const client = new line.Client(config); // 管理者（紹介者）のLINEユーザーID（Renderの環境変数で設定する） const ADMIN_USER_ID = process.env.ADMIN_USER_ID; // Expressアプリのセットアップ const app = express(); // セッション管理（ユーザーごとの登録フロー状態を保持） const sessions = {}; function findOrCreateSession(userId) { if (!sessions[userId]) { sessions[userId] = { step: null, data: {} }; } return sessions[userId]; } // Webhookエンドポイント app.post('/webhook', line.middleware(config), (req, res) => { Promise .all(req.body.events.map(handleEvent)) .then(result => res.json(result)) .catch(err => { console.error('Error handling events:', err); res.status(500).end(); }); }); // イベント処理関数 async function handleEvent(event) { // 対象以外のイベントタイプは無視 if (event.type !== 'message' && event.type !== 'postback') { return Promise.resolve(null); } const userId = event.source.userId; const session = findOrCreateSession(userId); // メッセージイベントの処理 if (event.type === 'message' && event.message.type === 'text') { const userMessage = event.message.text; // 1. 「登録希望」ボタン（メッセージアクションとして送信された場合） if (userMessage === '登録希望') { // 「登録希望」押下時の処理を実行（管理者通知＋ユーザーへの案内返信） return handleRegisterRequest(userId, event.replyToken); } // 2. 「3点をLINEで返信する」ボタン（メッセージアクションとして送信された場合） if (userMessage === '3点をLINEで返信する') { // 登録フロー開始処理を実行（セッション開始＋案内メッセージ） return handleStartRegistration(userId, event.replyToken); } // 3. 登録フロー進行中の入力処理 if (session.step === 'AWAITING_NAME') { // 氏名を受信 session.data.name = userMessage; session.step = 'AWAITING_FLP'; const replyText = 'FLP番号を送ってください。'; // 次にFLP番号を要求 return client.replyMessage(event.replyToken, { type: 'text', text: replyText }); } else if (session.step === 'AWAITING_FLP') { // FLP番号を受信 session.data.flp = userMessage; session.step = 'AWAITING_IMAGE'; const replyText = '登録用の画像を送ってください。'; // 次に画像を要求 return client.replyMessage(event.replyToken, { type: 'text', text: replyText }); } else if (session.step === 'AWAITING_IMAGE') { // 画像待ちの状態でテキストが送られてきた場合 const replyText = '画像を送ってください。'; // 画像送信をリマインド return client.replyMessage(event.replyToken, { type: 'text', text: replyText }); } else { // 特にハンドリングしないメッセージ（通常は無視かエコー） return Promise.resolve(null); } } // 画像メッセージイベントの処理（登録フローで画像待ちの場合） if (event.type === 'message' && event.message.type === 'image') { if (session.step === 'AWAITING_IMAGE') { // ユーザーが登録用の画像を送信した session.data.imageId = event.message.id; // 画像メッセージIDを保存 const name = session.data.name || ''; const flp = session.data.flp || ''; // 管理者へ登録情報を通知（氏名・FLP番号・ユーザーID等） if (ADMIN_USER_ID) { const adminText = `登録者から情報が届きました。\n氏名: ${name}\nFLP番号: ${flp}\nユーザーID: ${userId}\n※画像データ受信済み`; client.pushMessage(ADMIN_USER_ID, { type: 'text', text: adminText }) .catch(err => console.error('Failed to push message to admin:', err)); } // ユーザーへ受付完了メッセージ const thankYouMessage = { type: 'text', text: '登録情報を受け付けました。ありがとうございました。' }; // セッション状態をリセット sessions[userId] = { step: null, data: {} }; return client.replyMessage(event.replyToken, thankYouMessage); } else { // 想定外の画像メッセージは無視 return Promise.resolve(null); } } // ポストバックイベントの処理 if (event.type === 'postback') { const data = event.postback.data; // 1. 「登録希望」ボタン（ポストバックアクションの場合） if (data === 'register_request' || data === '登録希望') { return handleRegisterRequest(userId, event.replyToken); } // 2. 「3点をLINEで返信する」ボタン（ポストバックアクションの場合） if (data === 'start_registration' || data === '3点をLINEで返信する') { return handleStartRegistration(userId, event.replyToken); } // その他のポストバックデータがあればここで処理 } return Promise.resolve(null); } // 「登録希望」ボタン押下時の処理：管理者通知＋ユーザーへの案内返信 function handleRegisterRequest(userId, replyToken) { // 管理者（紹介者）に登録希望の通知をプッシュ送信 if (ADMIN_USER_ID) { const adminMsg = { type: 'text', text: '登録希望者が来ました。' }; client.pushMessage(ADMIN_USER_ID, adminMsg) .catch(err => console.error('Failed to push admin notification:', err)); } // ユーザーへ登録方法の案内メッセージを返信（仮の文面） const userMsg = { type: 'text', text: '登録方法をご案内します。こちらから順に対応してください。' }; // ※上記の案内メッセージ文言は仮置きです（必要に応じて変更してください） return client.replyMessage(replyToken, userMsg); } // 「3点をLINEで返信する」ボタン押下時の処理：登録フロー開始 function handleStartRegistration(userId, replyToken) { // ユーザーのセッション状態を初期化して登録フローへ移行 sessions[userId] = { step: 'AWAITING_NAME', data: {} }; // 最初の案内メッセージを送信（氏名の入力促し） const promptMsg = { type: 'text', text: '登録を開始します。氏名を送ってください。' }; return client.replyMessage(replyToken, promptMsg); } // サーバ起動 const PORT = process.env.PORT || 3000; app.listen(PORT, () => { console.log(`Server is running at Port ${PORT}`); }); 
